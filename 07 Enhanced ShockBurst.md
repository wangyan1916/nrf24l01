# 7 Enhanced ShockBurst

增强型 ShockBurst™ 是基于数据包的数据链路层。

它具有自动数据包组装和计时、自动确认和重新传输数据包的功能。

增强型 ShockBurst™ 可实现与低成本主机微控制器的超低功耗、高性能通信。

这些功能可显着提高双向和单向系统的电源效率，而不会增加主机控制器端的复杂性。

## 7.1 特性

增强型 ShockBurst™ 的主要特点是：

- 1 至 32 字节动态负载长度
- 自动数据包处理
- 自动数据包事务处理
  - 自动确认
  - 自动重传
- 用于 1:6 星形网络的 6 个数据管道 MultiCeiver™

## 7.2 增强型 ShockBurst™ 概述

增强型 ShockBurst™ 使用 ShockBurst™ 进行自动数据包处理和计时。

在传输过程中，ShockBurst™ 组装数据包并将数据包中的位计时到发送器中进行传输。

在接收过程中，ShockBurst™ 不断在解调信号中搜索有效地址。

- 当 ShockBurst™ 找到有效地址时，它会处理数据包的其余部分并通过 CRC 对其进行验证。
- 如果数据包有效，则有效负载将移至 RX FIFO 中。
- 高速位处理和定时由 ShockBurst™ 控制

增强型 ShockBurst™ 具有自动数据包事务处理功能，可实现可靠的双向数据链路。

增强型 ShockBurst™ 数据包事务是收发器之间的数据包交换，其中一个收发器是主接收器 (PRX)，另一个是主发送器 (PTX)。

增强型 ShockBurst™ 数据包事务始​​终由 PTX 的数据包传输发起，当 PTX 收到来自 PRX 的确认数据包（ACK 数据包）时事务完成。

自动数据包事务处理的工作原理如下：

- 用户通过将数据包从PTX发送到PRX来发起交易。 增强型 ShockBurst™ 自动将 PTX 设置为接收模式以等待 ack 数据包。
- 如果 PRX 收到数据包，Enhanced ShockBurst™ 会在返回接收模式之前自动组装并向 PTX 发送确认数据包（ACK 数据包）
- 如果 PTX 在设定时间内没有收到 ACK 数据包，Enhanced ShockBurst™ 将自动重传原始数据包，并将 PTX 设置为接收模式以等待 ACK 数据包

PRX 可以将用户数据附加到 ACK 数据包上，从而实现双向数据链路。增强型 ShockBurst™ 具有高度可配置性； 可以配置参数，例如最大重传次数以及从一次传输到下一次重传的延迟。 所有自动处理都是在没有 MCU 参与的情况下完成的。

[7.3 节](#73-增强型-shockburst-数据包格式)介绍了增强型 ShockBurst 数据包格式；

[7.4 节](#74-自动数据包处理)介绍了自动数据包处理；

[7.5 节](#75-自动数据包拆包处理)介绍了自动数据包事务处理；

[7.6 节](#76-增强型-shockburst-流程图)提供了 PTX 和 PRX 操作的流程图

## 7.3 增强型 ShockBurst 数据包格式

本章介绍了增强型 ShockBurst™ 数据包的格式。

增强型 ShockBurst™ 数据包包含前导码字段、地址字段、数据包控制字段、有效负载字段和 CRC 字段。

图 4 显示了 MSB 位于左侧的数据包格式。

![图4](./images/fig04.png)

### 7.3.1 前导码字段

一个字节，`01010101`或`10101010`,根据地址第一位确定，目的是确保前导码有足够的转换来稳定接收器

### 7.3.2 地址

接收器的地址。确保正确的数据包背接收机所检测。

地址字段可通过 AW 寄存器配置为 3、4 或 5 个字节长。

注意：电平仅移动一次的地址会被检测为噪声，如（000FFFFFFF）

### 7.3.3 数据包控制字段

图5显示了9位数据包控制字段的格式，MSB在左边

![图5](./images/fig05.png)

数据包控制字段包含 6 位有效负载长度字段、2 位 PID（数据包标识）字段和 1 位 `NO_ACK`标志

#### 7.3.3.1 有效负载长度

这个 6 位字段指定有效负载的长度（以字节为单位）。

有效负载的长度可以是 0 到 32 字节。

编码：000000 = 0 字节（仅用于空 ACK 数据包。）100000 = 32 字节，100001 = 无关。

仅当启用动态负载长度功能时才使用该字段。

#### 7.3.3.2 PID（数据包识别）

2 位 PID 字段用于检测接收到的数据包是新的还是重传的。

PID 可防止 PRX 设备向 MCU 多次呈现相同的有效负载。

对于通过 SPI 接收到的每个新数据包，PID 字段在 TX 侧递增。

PRX 设备使用 PID 和 CRC 字段（请参阅第 26 页上的 7.3.5 节）来确定数据包是重传的还是新的。

当链路上丢失多个数据包时，PID 字段可能会等于最后接收到的 PID。 如果数据包与前一个数据包具有相同的 PID，则 nRF24L01 会比较两个数据包的 CRC 和。

如果 CRC 和也相等，则最后接收到的数据包将被视为先前接收到的数据包的副本并被丢弃。

#### 7.3.3.3 无确认标志(`NO_ACK`)

选择性自动确认功能控制 NO_ACK 标志。

该标志仅在使用自动确认功能时使用。

将标志设置为高电平，告诉接收者该数据包不会被自动确认。

### 7.3.4 有效负载

有效负载是用户定义的数据包内容。

它的宽度可以是 0 到 32 字节，并在上传（未修改）到设备时进行空中传输。

### 7.3.5CRC（循环冗余校验）

CRC 是数据包中的错误检测机制。

它可以是 1 或 2 个字节，并根据地址、数据包控制字段和有效负载进行计算。

1 字节 CRC 的多项式为 $X^8+X^2+X+1$。初始值 0xFF

2 字节 CRC 的多项式为 $X^{16}+X^{12}+X^5+1$。初始值 0xFFFF

## 7.4 自动数据包处理

增强型 ShockBurst™ 使用 ShockBurst™ 进行自动数据包处理。

功能有:

- 静态和动态有效负载长度
- 自动数据包组装
- 自动数据包验证
- 自动数据包分解

### 7.4.1 静态和动态有效负载长度

增强型 ShockBurst™ 提供了两种处理有效负载长度的替代方案：静态和动态。

默认替代方案是静态有效负载长度。 对于静态有效负载长度，发送器和接收器之间的所有数据包都具有相同的长度。静态负载长度由接收器侧的`RX_PW_Px`寄存器设置。发送器端的有效负载长度由时钟输入`TX_FIFO`的字节数设置，并且必须等于接收器端`RX_PW_Px`寄存器中的值

动态有效负载长度（DPL）是静态有效负载长度的替代方案。DPL 使发送器能够向接收器发送具有可变有效负载长度的数据包。这意味着对于具有不同有效负载长度的系统，无需将数据包长度调整为最长有效负载。

借助 DPL 功能，nRF24L01 可以自动解码接收到的数据包的有效负载长度，而无需使用 `RX_PW_Px`寄存器。  MCU 可以使用`R_RX_PL_WID`命令读取接收到的有效负载的长度。

为了启用 DPL，必须设置`FEATURE`寄存器中的`EN_DPL`位。

在 RX 模式下，必须设置 `DYNPD`寄存器。 发送到启用 DPL 的 PRX 的 PTX 必须设置`DYNPD`中的`DPL_P0`位。

### 7.4.2 自动包组装

自动数据包组装将前导码、地址、数据包控制字段、有效负载和 CRC 组装成一个完整的数据包，然后再进行传输。

### 7.4.3 自动数据包验证

增强型 ShockBurst™ 具有自动数据包验证功能。 在接收模式下，nRF24L01 不断搜索有效地址（在 RX_ADDR 寄存器中给出）。如果检测到有效地址，Enhanched ShockBurst™ 将开始验证数据包。

对于静态数据包长度，Enhanced ShockBurst™ 将根据 RX_PW 寄存器给定的长度捕获数据包。 使用 DPL 增强型 ShockBurst™ 根据数据包控制字段中的有效负载长度字段捕获数据包。 捕获数据包后，Enhanced ShockBurst™ 将执行 CRC。

如果 CRC 有效，Enhanced ShockBurst™ 将检查 PID。 将接收到的 PID 与之前接收到的 PID 进行比较。 如果 PID 字段不同，则认为该数据包是新的。 如果 PID 字段相等，接收器必须检查接收到的 CRC 是否等于先前的 CRC。 如果 CRC 相等，则该数据包被定义为与前一个数据包相同并被丢弃。 请参阅图 6 中的流程图

![图6](./images/fig06.png)

### 7.4.4 自动拆包

数据包经过验证后，Enhanced ShockBurst™ 会分解数据包并将有效负载加载到`RX FIFO`中，并置位`RX_DR IRQ`

## 7.5 自动数据包拆包处理

增强型 ShockBurst™ 具有两种自动数据包事务处理功能； 自动确认和自动重传。

### 7.5.1 自动确认

自动确认是一种在 PTX 接收并验证数据包后自动向 PTX 发送 ACK 数据包的功能。 自动确认功能可减轻系统 MCU 的负载，并且无需专用 SPI 硬件。 这也降低了成本和平均电流消耗。 通过设置`EN_AA`寄存器来启用自动确认功能

注意：如果接收到的数据包设置了`NO_ACK`标志，则不执行自动确认。

ACK 数据包可以包含从 PRX 到 PTX 的可选有效负载。 为了使用此功能，必须启用动态有效负载长度功能。  PRX 侧的 MCU 必须使用`W_ACK_PAYLOAD`命令将有效负载计时到`TX FIFO`中，从而上传有效负载。 有效负载在`TX FIFO (PRX)`中等待，直到从 PTX 接收到新数据包为止。  

nRF24L01 可以同时在`TX FIFO (PRX)`中保留三个待处理的 ACK 数据包有效负载

![图7](./images/fig07.png)

图 7 显示了处理待处理 ACK 数据包有效负载时`TX FIFO (PRX)`的工作方式。 从 MCU 中，通过`W_ACK_PAYLOAD`命令记录有效负载。

地址解码器和缓冲区控制器确保有效负载存储在`TX FIFO (PRX)`的空闲槽中。 当接收到数据包时，地址解码器和缓冲区控制器会收到 PTX 地址通知。

这确保了向 ACK 生成器提供正确的有效负载

如果`TX FIFO (PRX)`包含多个 PTX 有效负载，则将使用先进先出原则处理有效负载。

如果所有挂起的有效负载都被寻址到链路丢失的 PTX，则`TX FIFO (PRX)`将被阻止。 在这种情况下，MCU 可以使用`FLUSH_TX`命令刷新 `TX FIFO (PRX)`。

为了启用有效负载自动确认，必须设置 `FEATURE` 寄存器中的 `EN_ACK_PAY` 位

### 7.5.2 自动重传（ART）

## 7.6 增强型 ShockBurst 流程图

本节显示了增强型 ShockBurst™ 中 PTX 和 PRX 操作的流程图。  ShockBurst™ 操作在流程图中用虚线方块标记

### 7.6.1 PTX 操作

图 8 中的流程图显示了配置为 PTX 的 nRF24L01 在进入待机 I 模式后的行为方式。

![图8-1](./images/fig08-1.png)
![图8-2](./images/fig08-2.png)

您可以通过将 CE 引脚设置为高电平来激活 PTX 模式。 如果 TX FIFO 中存在数据包，则 nRF24L01 进入 TX 模式并传输该数据包。 检查 NO_ACK 标志是否设置。

如果未设置，nRF24L01 进入 RX 模式以接收 ACK 数据包。 如果接收到的 ACK 数据包为空，则仅断言 `TX_DS` IRQ。 如果 ACK 数据包包含有效负载，则在 nRF24L01 返回待机 I 模式之前，`TX_DS` IRQ 和 `RX_DR` IRQ 会同时置位。

如果在超时之前未收到 ACK 数据包，nRF24L01 将返回待机 I 模式。 它保持在待机-I 模式，直到 ARD 结束。 如果重传次数未达到 ARC，则 nRF24L01 进入 TX 模式并再次发送最后一个数据包。

执行自动重传功能时，重传次数可以达到ARC中定义的最大次数。 如果发生这种情况，nRF24L01 将置位 `MAX_RT` IRQ 并返回待机 I 模式。

如果 CE 为高电平且 TX FIFO 为空，则 nRF24L01 进入待机 II 模式。

### 7.6.2 PRX 操作

图 9 中的流程图显示了配置为 PRX 的 nRF24L01 在进入待机 I 模式后的行为方式。

![图9](./images/fig09-1.png)
![图9](./images/fig09-2.png)

您可以通过将 CE 引脚设置为高电平来激活 PRX 模式。  nRF24L01 进入 RX 模式并开始搜索数据包。 如果接收到数据包并且启用了自动确认，nRF24L01 会决定这是一个新数据包还是先前接收到的数据包的副本。 如果数据包是新的，则有效负载在 `RX FIFO` 中可用，并且 `RX_DR` IRQ 被置位。 如果从发送器收到的最后一个数据包通过带有有效负载的 ACK 数据包进行确认，则 `TX_DS` IRQ 指示 PTX 已收到带有有效负载的 ACK 数据包。 如果接收到的数据包中未设置 No_ACK 标志，则 PRX 进入 TX 模式。 如果 TX FIFO 中有待处理的有效负载，则会将其附加到 ACK 数据包。 发送 ACK 数据包后，nRF24L01 返回 RX 模式。

如果 ACK 数据包丢失，则可能会收到先前接收到的数据包的副本。 在这种情况下，PRX 会丢弃接收到的数据包并在返回到 RX 模式之前发送 ACK 数据包。

## 7.7 多接收器

多接收器是 RX 模式中使用的一项功能，包含一组具有唯一地址的 6 个并行数据管道。
数据管道是物理RF信道中的逻辑信道。  

nRF24L01 中的每个数据管道都有自己的物理地址解码。

![图10](./images/fig10.png)

配置为 PRX（主接收器）的 nRF24L01 可以接收寻址到一个频道中六个不同数据管道的数据，如图 10 所示。每个数据管道都有自己唯一的地址，并且可以针对单独的行为进行配置。

最多 6 个配置为 PTX 的 nRF24L01 可以与配置为 PRX 的 1 个 nRF24L01 进行通信。 同时搜索所有数据管道地址。 一次只有一个数据管道可以接收数据包。

所有数据管道都可以执行增强型 ShockBurst™ 功能。

以下设置对于所有数据管道都是通用的：

- CRC 启用/禁用（启用增强型 ShockBurst™ 时 CRC 始终启用）
- CRC 编码方案
- RX 地址宽度
- 频道
- 空中数据速率
- LNA 增益

数据管道通过 `EN_RXADDR` 寄存器中的位启用。 默认情况下仅启用数据管道 0 和 1。

每个数据管道地址都在 `RX_ADDR_PX` 寄存器中配置。

每个管道最多可以有 5 个字节的可配置地址。

数据管道0有一个唯一的5字节地址。 数据管道 1-5 共享 4 个最高有效地址字节。

LSByte 对于所有 6 个管道必须是唯一的。

图 11是如何寻址数据管道 0-5 的示例。

![图11](./images/fig11.png)

PRX 使用多接收器和增强型 ShockBurst™，从多个 PTX 接收数据包。 为了确保来自 PRX 的 ACK 数据包传输到正确的 PTX，PRX 获取接收数据包的数据管道地址，并将其用作传输 ACK 数据包时的 TX 地址。

图 12 是 PRX 和 PTX 地址配置的示例。 在 PRX 上，定义为管道地址的 RX_ADDR_Pn 必须是唯一的。 在 PTX 上，TX_ADDR 必须与 RX_ADDR_P0 以及指定管道的管道地址相同。

![图12](./images/fig12.png)

在检测到其地址的数据管道接收到完整的数据包之前，其他数据管道都无法接收数据。 当多个 PTX 向 PRX 传输时，ARD 可用于倾斜自动重传，以便它们仅相互阻塞一次。

## 7.8 增强的 ShockBurstTM 时序

本节介绍增强型 ShockBurst™ 的时序以及所有模式的启动和操作方式。

增强型 ShockBurst™ 时序通过数据和控制接口进行控制。

nRF24L01 可设置为静态模式或自主模式，其中内部状态机控制事件。 每个自主模式/序列均以 IRQ 引脚处的中断结束。 所有中断在时序图中均表示为 IRQ 事件。

![fig13](./images/fig13.png)

![fig14](./images/fig14.png)

## 7.9 增强型ShockBurstTM Transaction 图

本节介绍了增强型 ShockBurst™ 自动事务处理的几种场景。 本节图中的标注表示 IRQ 和其他事件。 对于 MCU 活动，事件可能会被放置在不同的时间范围内。

注意：本节中的数字表示数据包到 MCU 的最早可能下载 (DL) 以及有效负载到发射器的最晚可能上传 (UL)

### 7.9.1 具有 ACK 数据包和中断的单个事务

图 15 显示了基本的自动确认。 在 PTX 发送数据包并由 PRX 接收数据包之后，ACK 数据包从 PRX 发送到 PTX。  RX_DR IRQ 在 PRX 接收到数据包后置位，而 TX_DS IRQ 在数据包被确认且 PTX 接收到 ACK 数据包时置位。

![fig15](./images/fig15.png)

### 7.9.2 丢失数据包的单笔交易

图 16 是由于第一个数据包传输丢失而需要重传的场景。 数据包发送后，PTX 进入 RX 模式以接收 ACK 数据包。 第一次传输后，PTX 等待 ACK 数据包指定的时间，如果不在特定时隙内，PTX 会重传数据包，如图 16 所示。

![fig16](./images/fig16.png)

### 7.9.3 丢失 ACK 数据包的单个事务

图 17. 是 ACK 数据包丢失后需要重传的场景。 还指示了相应的中断。

![fig17](./images/fig17.png)

### 7.9.4 带有 ACK 有效负载数据包的单个事务

图 18. 是带有有效负载的基本自动确认的场景。 在 PTX 发送数据包并由 PRX 接收数据包后，带有有效负载的 ACK 数据包从 PRX 发送到 PTX。

RX_DR IRQ 在 PRX 接收到数据包后置位，而在 PTX 侧，当 PTX 接收到 ACK 数据包时，TX_DS IRQ 置位。 在 PRX 侧，收到来自 PTX 的新数据包后，将断言 ACK 数据包有效负载的 TX_DS IRQ。 图 18 中 IRQ 的位置显示了 MCU 可以响应中断的位置。

![fig18](./images/fig18.png)

### 7.9.5 具有 ACK 有效负载数据包和丢失数据包的单个事务

图 19 是第一个数据包丢失并且在 PRX 侧的 RX_DR IRQ 置位之前需要重传的场景。 对于 PTX，收到 ACK 数据包后，TX_DS 和 RX_DR IRQ 均被置位。 在 PRX 侧接收到第二个数据包 (PID=2) 后，RX_DR (PID=2) 和 TX_DS（ACK 数据包有效负载）IRQ 均被置位。

![fig19](./images/fig19.png)

### 7.9.6 两个带有 ACK 有效负载数据包且第一个 ACK​​ 数据包丢失的事务

![fig20](./images/fig20.png)

在图 20 中，ACK 数据包丢失，在 TX_DS IRQ 置位之前需要重传，但 RX_DR IRQ 立即置位。 数据包的重传（PID=1）会导致数据包被丢弃。 对于 PTX，TX_DS 和 RX_DR IRQ 在收到第二次 ACK 传输后置位。 在 PRX 上接收到第二个数据包 (PID=2) 后，RX_DR (PID=2) 和 TX_DS (ACK1PAY) IRQ 均被置位。 标注解释了不同的事件和中断。

### 7.9.7 达到最大重传次数的两个事务

![fig21](./images/fig21.png)

如果自动重传计数器 (ARC_CNT) 超过编程的最大限制 (ARC)，则 MAX_RT IRQ 被置位。 在图 21 中，数据包传输以 MAX_RT IRQ 结束。  TX FIFO 中的有效负载不会被删除，并且由 MCU 决定协议的下一步。  CE 的切换启动传输相同数据包的新序列。 可以使用 FLUSH_TX 命令从 TX FIFO 中删除有效负载。

## 7.10 与 ShockBurst™ 的兼容性

![fig22](./images/fig22.png)
